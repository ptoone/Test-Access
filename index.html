<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Test Access – HIV Testing Map (Ontario)</title>

  <link rel="shortcut icon" href="https://xyz.am/images/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="https://xyz.am/images/favicon.svg">
  <link rel="icon" type="image/png" href="https://xyz.am/images/favicon.png">
  <link rel="apple-touch-icon" href="https://xyz.am/images/favicon.png">

  <!-- Open Graph -->
  <meta property="og:title" content="Test Access – HIV Testing Map (Ontario)">
  <meta property="og:description" content="Privacy-first map to find HIV testing services across Ontario. Search by postal code and filter by distance.">
  <meta property="og:image" content="https://xyz.am/assets/img/social-default.png">
  <meta property="og:url" content="https://testaccess.xyz.am/">
  <meta property="og:type" content="website">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body { background: #f8fafb; }
    .hero {
      background: linear-gradient(135deg, #00b46f 0%, #008f82 60%, #00698f 100%);
      color: #fff;
    }
    #map {
      width: 100%;
      height: min(70vh, 720px);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .searchbar {
      border-radius: 999px;
      padding-left: 1.1rem;
      padding-right: 1.1rem;
      height: 56px;
      font-size: 1.05rem;
    }
    .pill-btn { border-radius: 999px; }
    .small-muted { color: rgba(255,255,255,0.85); }
    pre, code, textarea.form-control {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .badge-soft {
      background: rgba(0, 180, 111, 0.12);
      color: #067a53;
      border: 1px solid rgba(0, 180, 111, 0.18);
    }
    .result-item:hover { background: #f7fafc; }
    .sticky-controls {
      position: sticky;
      top: 12px;
      z-index: 5;
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; margin-right: 6px;
      background: #00b46f;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">Test Access</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#mapSection">Map</a></li>
          <li class="nav-item"><a class="nav-link" href="#embed">Embed</a></li>
          <li class="nav-item"><a class="nav-link" href="https://github.com/ptoone/Test-Access" target="_blank" rel="noopener">GitHub</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero py-5">
    <div class="container">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <h1 class="display-5 fw-bold mb-3">HIV Testing Map for Ontario</h1>
          <p class="lead mb-2">
            Search by postal code to find nearby organizations and health services that can help with HIV testing.
          </p>
          <p class="small-muted mb-4">
            Privacy-first: no accounts, no tracking, no stored searches. Always confirm hours and service details before visiting.
          </p>

          <div class="bg-white text-dark rounded-4 shadow-sm p-3 p-md-4">
            <div class="d-flex flex-column flex-md-row gap-2">
              <input id="postcodeInput" class="form-control searchbar"
                     placeholder="Enter an Ontario postal code (e.g. M5V 2T6) or town/city"
                     autocomplete="postal-code" inputmode="text">
              <button id="searchBtn" class="btn btn-success pill-btn px-4" type="button">
                Search
              </button>
              <button id="showAllBtn" class="btn btn-outline-secondary pill-btn px-4" type="button">
                Show All
              </button>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Radius: <span id="radiusLabel">25</span> km</label>
                <input id="radiusRange" type="range" class="form-range" min="5" max="250" step="5" value="25">
                <div class="d-flex justify-content-between small text-muted">
                  <span>5 km</span><span>250 km</span>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Results</label>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="closestOnly">
                    <label class="form-check-label" for="closestOnly">Closest only</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="useMyLocation">
                    <label class="form-check-label" for="useMyLocation">Use my location</label>
                  </div>
                  <span class="badge badge-soft">OpenStreetMap + Leaflet</span>
                </div>
                <div class="small text-muted mt-2">
                  Tip: “Use my location” stays in your browser (nothing is sent to us).
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-2">
              <button id="shareBtn" class="btn btn-dark pill-btn btn-sm" type="button">Copy share link</button>
              <button id="copyEmbedBtnTop" class="btn btn-outline-dark pill-btn btn-sm" type="button">Copy embed code</button>
              <span id="statusMsg" class="small text-muted"></span>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="bg-white text-dark rounded-4 shadow-sm p-4">
            <h2 class="h5 fw-bold mb-2">What this map shows</h2>
            <ul class="mb-0 ps-3">
              <li>Organizations and clinics that may provide HIV testing info/services</li>
              <li>Search by postal code or location name</li>
              <li>Filter by distance radius and show closest option</li>
              <li>Easy to share and embed on other sites</li>
            </ul>
            <hr>
            <div class="small text-muted">
              If you need urgent medical help, call 911 or your local emergency services.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main class="container py-4 pb-5">

    <!-- Map + Results -->
    <section id="mapSection" class="mt-2">
      <div class="row g-4">
        <div class="col-lg-8">
          <div id="map" aria-label="Map of locations"></div>
          <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
            <div><span class="legend-dot"></span>Locations</div>
            <div id="mapHint">Move or zoom the map—your view is saved in the share link.</div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm sticky-controls">
            <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
              <span>Nearby locations</span>
              <span class="badge text-bg-secondary" id="countBadge">0</span>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="small text-muted">
                  Data file:
                </div>
                <code class="small" id="dataUrlDisplay"></code>
              </div>

              <div class="alert alert-warning small" id="noCoordsWarning" style="display:none;">
                Some entries don’t have coordinates yet. The map will try to place them by geocoding the address
                (cached locally in your browser). For best performance, add lat/lng to the JSON.
              </div>

              <div id="results" class="list-group list-group-flush"></div>

              <div class="mt-3 small text-muted">
                Missing or incorrect info? Contribute on
                <a href="https://github.com/ptoone/Test-Access" target="_blank" rel="noopener">GitHub</a>.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- Embed -->
    <section id="embed" class="mt-5">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Embed this map</div>
        <div class="card-body">
          <p class="mb-2">
            You can embed this map on any website using an <code>&lt;iframe&gt;</code>.
          </p>

          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label">Map URL</label>
              <input id="embedUrl" class="form-control" value="https://testaccess.xyz.am/">
              <div class="form-text">Tip: the share link includes the current zoom + centre.</div>
            </div>
            <div class="col-lg-6">
              <label class="form-label">Embed code</label>
              <textarea id="embedCode" class="form-control" rows="5" readonly></textarea>
              <div class="mt-2">
                <button id="copyEmbedBtn" class="btn btn-outline-secondary btn-sm" type="button">Copy</button>
              </div>
            </div>
          </div>

          <div class="small text-muted mt-3">
            You can change the iframe height/width in your own layout.
          </div>
        </div>
      </div>
    </section>

    <div class="text-center text-muted small mt-4">
      Built with <a href="https://www.openstreetmap.org" target="_blank" rel="noopener">OpenStreetMap</a>,
      <a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a>,
      and hosted on <a href="https://xyz.am" target="_blank" rel="noopener">XYZ.AM</a>.
      Please verify services before visiting.
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /************************************************************
     * CONFIG
     ************************************************************/
    // Point this to your cleaned JSON file.
    // You can host it in the repo as data/ontario.json and use the raw GitHub URL.
    const DATA_URL = "https://raw.githubusercontent.com/ptoone/Test-Access/main/data/ontario.json";

    // Approximate map start (Ontario)
    const DEFAULT_CENTER = [50.0, -85.0];
    const DEFAULT_ZOOM = 5;

    // Local cache key for geocoded addresses
    const GEO_CACHE_KEY = "testaccess_geocache_v1";

    /************************************************************
     * HELPERS
     ************************************************************/
    function $(id){ return document.getElementById(id); }

    function setStatus(msg, isError=false){
      const el = $("statusMsg");
      el.textContent = msg;
      el.className = "small " + (isError ? "text-danger" : "text-muted");
      if (msg) setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 5000);
    }

    // Haversine (km)
    function distanceKm(aLat, aLng, bLat, bLng){
      const R = 6371;
      const toRad = d => d * Math.PI/180;
      const dLat = toRad(bLat - aLat);
      const dLng = toRad(bLng - aLng);
      const s1 = Math.sin(dLat/2);
      const s2 = Math.sin(dLng/2);
      const aa = s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
      return 2 * R * Math.asin(Math.sqrt(aa));
    }

    function normalizeQuery(q){
      return (q || "").trim().replace(/\s+/g, " ");
    }

    // Lightly accept Canadian postal codes, but also allow city/town search.
    function looksLikePostalCode(q){
      const s = q.toUpperCase().replace(/\s/g, "");
      return /^[A-Z]\d[A-Z]\d[A-Z]\d$/.test(s);
    }

    // Get permalink that stores current map view in hash (#lat,lng,zoom)
    function getPermalink(){
      const c = map.getCenter();
      const z = map.getZoom();
      const base = location.origin + location.pathname;
      return `${base}#${c.lat.toFixed(5)},${c.lng.toFixed(5)},${z}`;
    }

    function applyHashView(){
      if (!location.hash) return;
      const raw = location.hash.replace("#","").trim();
      const parts = raw.split(",");
      if (parts.length !== 3) return;
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      const zoom = parseInt(parts[2], 10);
      if (!isNaN(lat) && !isNaN(lng) && !isNaN(zoom)) {
        map.setView([lat,lng], zoom);
      }
    }

    function updateEmbedCode(){
      const url = $("embedUrl").value.trim() || "https://testaccess.xyz.am/";
      $("embedCode").value =
`<iframe
  src="${url}"
  width="100%"
  height="650"
  style="border:0;border-radius:12px;overflow:hidden"
  loading="lazy"
  referrerpolicy="no-referrer-when-downgrade">
</iframe>`;
    }

    function copyToClipboard(text){
      return navigator.clipboard.writeText(text);
    }

    /************************************************************
     * LEAFLET MAP
     ************************************************************/
    const map = L.map("map", { zoomControl: true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a>'
    }).addTo(map);

    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    applyHashView();

    // Track user's search origin marker + radius
    let originMarker = null;
    let radiusCircle = null;

    // Layer group for location markers
    const markersLayer = L.layerGroup().addTo(map);

    // Keep data in memory
    let locations = [];
    let hasMissingCoords = false;

    // Local geocode cache
    function loadGeoCache(){
      try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveGeoCache(cache){
      try { localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache)); } catch {}
    }

    /************************************************************
     * DATA LOADING
     ************************************************************/
    $("dataUrlDisplay").textContent = DATA_URL;

    async function fetchLocations(){
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load data.");
      const data = await res.json();
      // allow either array or FeatureCollection later
      return Array.isArray(data) ? data : (data.features || []);
    }

    /************************************************************
     * GEOCODING
     ************************************************************/
    // Nominatim request (respectful, one-off, no bulk loops)
    async function nominatimSearch(q){
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");
      url.searchParams.set("addressdetails", "1");
      url.searchParams.set("q", q);

      const res = await fetch(url.toString(), {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) throw new Error("Geocoder error");
      const j = await res.json();
      return j && j[0] ? { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) } : null;
    }

    async function geocodeQueryToLatLng(query){
      const q = normalizeQuery(query);
      if (!q) return null;

      // bias to Ontario, Canada
      const enriched = looksLikePostalCode(q)
        ? `${q}, Ontario, Canada`
        : `${q}, Ontario, Canada`;

      const hit = await nominatimSearch(enriched);
      return hit;
    }

    // Geocode a single location if missing coords, cache by address|city|org
    async function ensureLocationCoords(loc){
      if (loc.lat && loc.lng) return loc;

      const cache = loadGeoCache();
      const key = `${loc.organization}|${loc.address}|${loc.city}`.toLowerCase();

      if (cache[key]) {
        loc.lat = cache[key].lat;
        loc.lng = cache[key].lng;
        return loc;
      }

      // One-off geocode; keep it gentle to avoid abuse.
      const q = `${loc.address || ""}, ${loc.city || ""}, Ontario, Canada`;
      const hit = await nominatimSearch(q);
      if (hit) {
        loc.lat = hit.lat;
        loc.lng = hit.lng;
        cache[key] = hit;
        saveGeoCache(cache);
      }
      return loc;
    }

    /************************************************************
     * RENDERING
     ************************************************************/
    function clearOrigin(){
      if (originMarker) { map.removeLayer(originMarker); originMarker = null; }
      if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
    }

    function setOrigin(lat, lng, label){
      clearOrigin();
      originMarker = L.marker([lat,lng]).addTo(map).bindPopup(label || "Search location");
      radiusCircle = L.circle([lat,lng], {
        radius: parseInt($("radiusRange").value, 10) * 1000
      }).addTo(map);
    }

    function setRadiusCircleKm(km){
      if (!radiusCircle) return;
      radiusCircle.setRadius(km * 1000);
    }

    function makePopup(loc, distText){
      const org = escapeHtml(loc.organization || "Unknown");
      const addr = escapeHtml(loc.address || "");
      const city = escapeHtml(loc.city || "");
      const area = escapeHtml(loc.service_area || "");
      const website = loc.website ? `<a href="${escapeAttr(loc.website)}" target="_blank" rel="noopener">Visit website</a>` : "";
      const dist = distText ? `<div class="small text-muted mt-1">${distText}</div>` : "";

      return `
        <div style="min-width:220px">
          <div class="fw-semibold">${org}</div>
          <div class="small">${addr}${addr && city ? ", " : ""}${city}</div>
          ${area ? `<div class="small text-muted mt-1">${area}</div>` : ""}
          ${website ? `<div class="mt-2">${website}</div>` : ""}
          ${dist}
        </div>
      `;
    }

    function renderMarkers(list, origin){
      markersLayer.clearLayers();

      const bounds = [];
      list.forEach(loc => {
        if (!loc.lat || !loc.lng) return;
        const distText = origin ? `${loc._distanceKm.toFixed(1)} km away` : "";
        const m = L.marker([loc.lat, loc.lng]).bindPopup(makePopup(loc, distText));
        m.addTo(markersLayer);
        bounds.push([loc.lat, loc.lng]);
      });

      if (origin) bounds.push([origin.lat, origin.lng]);

      if (bounds.length) {
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.2));
      }
    }

    function renderResults(list){
      const el = $("results");
      el.innerHTML = "";

      $("countBadge").textContent = String(list.length);

      if (!list.length){
        el.innerHTML = `<div class="text-muted small p-2">No results yet. Search by postal code or click “Show All”.</div>`;
        return;
      }

      list.forEach((loc, idx) => {
        const a = document.createElement("a");
        a.href = "#";
        a.className = "list-group-item list-group-item-action result-item";
        const dist = (typeof loc._distanceKm === "number") ? `<div class="small text-muted">${loc._distanceKm.toFixed(1)} km away</div>` : "";
        a.innerHTML = `
          <div class="fw-semibold">${escapeHtml(loc.organization || "Unknown")}</div>
          <div class="small">${escapeHtml(loc.address || "")}${loc.address && loc.city ? ", " : ""}${escapeHtml(loc.city || "")}</div>
          ${dist}
        `;
        a.addEventListener("click", (e) => {
          e.preventDefault();
          if (loc.lat && loc.lng) {
            map.setView([loc.lat, loc.lng], Math.max(map.getZoom(), 12));
          }
          // open popup
          // find marker in layer by coords
          markersLayer.eachLayer(layer => {
            const ll = layer.getLatLng?.();
            if (ll && Math.abs(ll.lat - loc.lat) < 1e-9 && Math.abs(ll.lng - loc.lng) < 1e-9) {
              layer.openPopup();
            }
          });
        });
        el.appendChild(a);
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function escapeAttr(str){
      return String(str || "").replace(/"/g, "&quot;");
    }

    /************************************************************
     * SEARCH + FILTER LOGIC
     ************************************************************/
    async function showAll(){
      setStatus("Loading locations…");
      const list = [];

      // show only items that have coords (or can be geocoded)
      for (const loc of locations){
        const withCoords = await ensureLocationCoords(loc);
        if (withCoords.lat && withCoords.lng) list.push(withCoords);
      }

      renderMarkers(list, null);
      renderResults(list);
      setStatus(`Showing all locations (${list.length}).`);
      updateHashOnMove();
    }

    async function runSearchByOrigin(originLatLng){
      const radiusKm = parseInt($("radiusRange").value, 10);
      setOrigin(originLatLng.lat, originLatLng.lng, "Search area");
      setRadiusCircleKm(radiusKm);

      setStatus("Finding nearby locations…");

      const list = [];
      for (const loc of locations){
        const withCoords = await ensureLocationCoords(loc);
        if (!withCoords.lat || !withCoords.lng) continue;

        const d = distanceKm(originLatLng.lat, originLatLng.lng, withCoords.lat, withCoords.lng);
        withCoords._distanceKm = d;

        if (d <= radiusKm) list.push(withCoords);
      }

      list.sort((a,b) => a._distanceKm - b._distanceKm);

      if ($("closestOnly").checked && list.length) {
        renderMarkers([list[0]], originLatLng);
        renderResults([list[0]]);
        setStatus("Showing closest location.");
      } else {
        renderMarkers(list, originLatLng);
        renderResults(list);
        setStatus(`Found ${list.length} location(s) within ${radiusKm} km.`);
      }
      updateHashOnMove();
    }

    async function search(){
      const q = normalizeQuery($("postcodeInput").value);
      if (!q && !$("useMyLocation").checked){
        setStatus("Enter a postal code or enable “Use my location”.", true);
        return;
      }

      // Use my location (browser)
      if ($("useMyLocation").checked){
        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const origin = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          await runSearchByOrigin(origin);
        }, (err) => {
          setStatus("Could not access location. Please enter a postal code instead.", true);
        }, { enableHighAccuracy: false, timeout: 8000 });
        return;
      }

      setStatus("Searching…");
      try{
        const origin = await geocodeQueryToLatLng(q);
        if (!origin){
          setStatus("Couldn’t find that location. Try a different postal code or city.", true);
          return;
        }
        await runSearchByOrigin(origin);
      } catch (e){
        setStatus("Search failed. Try again in a moment.", true);
      }
    }

    /************************************************************
     * SHARE + EMBED
     ************************************************************/
    function updateHashOnMove(){
      // keep hash updated so sharing is natural
      // (throttle a little)
      if (updateHashOnMove._t) clearTimeout(updateHashOnMove._t);
      updateHashOnMove._t = setTimeout(() => {
        const c = map.getCenter();
        const z = map.getZoom();
        history.replaceState(null, "", `#${c.lat.toFixed(5)},${c.lng.toFixed(5)},${z}`);
      }, 300);
    }
    map.on("moveend", updateHashOnMove);

    $("shareBtn").addEventListener("click", async () => {
      try{
        const link = getPermalink();
        await copyToClipboard(link);
        setStatus("Share link copied.");
        $("embedUrl").value = link;
        updateEmbedCode();
      } catch {
        setStatus("Couldn’t copy. Select the URL from the address bar.", true);
      }
    });

    function copyEmbedCurrent(){
      const link = getPermalink();
      $("embedUrl").value = link;
      updateEmbedCode();
      copyToClipboard($("embedCode").value)
        .then(() => setStatus("Embed code copied."))
        .catch(() => setStatus("Couldn’t copy embed code.", true));
    }

    $("copyEmbedBtnTop").addEventListener("click", copyEmbedCurrent);
    $("copyEmbedBtn").addEventListener("click", () => {
      copyToClipboard($("embedCode").value)
        .then(() => setStatus("Embed code copied."))
        .catch(() => setStatus("Couldn’t copy embed code.", true));
    });

    $("embedUrl").addEventListener("input", updateEmbedCode);

    /************************************************************
     * UI EVENTS
     ************************************************************/
    $("radiusRange").addEventListener("input", () => {
      $("radiusLabel").textContent = $("radiusRange").value;
      setRadiusCircleKm(parseInt($("radiusRange").value, 10));
      // if we already have origin, re-run radius filter quickly by "clicking" search
      // (no extra geocode if using my location is off and input already done)
    });

    $("searchBtn").addEventListener("click", search);
    $("showAllBtn").addEventListener("click", showAll);
    $("postcodeInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") search();
    });

    $("closestOnly").addEventListener("change", () => {
      // rerun search if origin exists
      if (originMarker){
        const ll = originMarker.getLatLng();
        runSearchByOrigin({ lat: ll.lat, lng: ll.lng });
      }
    });

    $("useMyLocation").addEventListener("change", () => {
      if ($("useMyLocation").checked){
        setStatus("Tip: click Search to use your current location.");
      }
    });

    /************************************************************
     * INIT
     ************************************************************/
    (async function init(){
      updateEmbedCode();

      try{
        setStatus("Loading data…");
        locations = await fetchLocations();

        // Normalize the records (support future lat/lng fields)
        locations = locations.map(x => ({
          id: x.id,
          organization: x.organization,
          address: x.address,
          city: x.city,
          service_area: x.service_area,
          website: x.website,
          lat: x.lat || (x.coords && x.coords.lat) || null,
          lng: x.lng || (x.coords && x.coords.lng) || null
        }));

        hasMissingCoords = locations.some(l => !l.lat || !l.lng);
        if (hasMissingCoords) {
          $("noCoordsWarning").style.display = "block";
        }

        // If hash view exists, set embed url to it
        $("embedUrl").value = getPermalink();
        updateEmbedCode();

        setStatus("Ready. Enter a postal code to search.");
      } catch (e){
        console.error(e);
        setStatus("Could not load the locations data file. Check DATA_URL.", true);
      }
    })();
  </script>
</body>
</html>
