<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Test Access – HIV Testing Map (Ontario)</title>

  <link rel="shortcut icon" href="https://xyz.am/images/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="https://xyz.am/images/favicon.svg">
  <link rel="icon" type="image/png" href="https://xyz.am/images/favicon.png">
  <link rel="apple-touch-icon" href="https://xyz.am/images/favicon.png">

  <meta property="og:title" content="Test Access – HIV Testing Map (Ontario)">
  <meta property="og:description" content="Find HIV testing resources near you. Search by postal code and filter by distance. Shareable + embeddable OpenStreetMap view.">
  <meta property="og:image" content="https://xyz.am/assets/img/social-default.png">
  <meta property="og:url" content="https://testaccess.xyz.am/">
  <meta property="og:type" content="website">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --accent: #00b46f;
      --bg: #f8fafb;
      --card: rgba(255,255,255,.96);
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --hero-grad: linear-gradient(135deg, #00b46f 0%, #008f82 60%, #00698f 100%);
    }

    body { background: var(--bg); color: var(--text); }

    /* Dark theme */
    body.theme-dark{
      --bg: #0b1220;
      --card: rgba(17,24,39,.85);
      --text: #e5e7eb;
      --muted: rgba(229,231,235,.70);
      --border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --hero-grad: linear-gradient(135deg, rgba(0,180,111,.85) 0%, rgba(0,143,130,.85) 55%, rgba(0,105,143,.85) 100%);
    }

    /* Make bootstrap elements look good in dark mode without rebuilding everything */
    body.theme-dark .navbar.bg-dark { background: #060a12 !important; }
    body.theme-dark .card { background: var(--card); border-color: var(--border); }
    body.theme-dark .card-header { background: rgba(0,0,0,.12); border-color: var(--border); color: var(--text); }
    body.theme-dark .form-control, body.theme-dark .form-select, body.theme-dark textarea.form-control{
      background: rgba(0,0,0,.20);
      border-color: var(--border);
      color: var(--text);
    }
    body.theme-dark .form-control::placeholder{ color: rgba(229,231,235,.55); }
    body.theme-dark .list-group-item{
      background: rgba(0,0,0,.18);
      border-color: var(--border);
      color: var(--text);
    }
    body.theme-dark .text-muted, body.theme-dark .small.text-muted{ color: var(--muted) !important; }
    body.theme-dark a{ color: rgba(125,211,252,.95); }
    body.theme-dark code{ color: rgba(229,231,235,.9); }

    .hero { background: var(--hero-grad); color: #fff; }
    #map {
      width: 100%;
      height: min(72vh, 760px);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      background: rgba(0,0,0,.03);
    }

    .searchbar {
      border-radius: 999px;
      padding-left: 1.1rem;
      padding-right: 1.1rem;
      height: 56px;
      font-size: 1.05rem;
    }
    .pill-btn { border-radius: 999px; }
    .small-muted { color: rgba(255,255,255,0.85); }

    .badge-soft {
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      color: color-mix(in srgb, var(--accent) 75%, #000 25%);
      border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
    }

    .result-item:hover { background: rgba(148,163,184,.18); }

    .sticky-controls { position: sticky; top: 12px; z-index: 5; }

    pre, code, textarea.form-control {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Scrollable results list (desktop + mobile friendly) */
    .results-scroll{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable;
      border-radius: 12px;
      overscroll-behavior: contain;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.65);
    }
    body.theme-dark .results-scroll{
      background: rgba(0,0,0,.12);
    }

    @media (min-width: 992px){
      .results-scroll{ max-height: calc(72vh - 140px); }
    }
    @media (max-width: 991.98px){
      .sticky-controls{ position: static; top: auto; }
      .results-scroll{ max-height: 52vh; }
    }

    #results .list-group-item{
      padding-top: .85rem;
      padding-bottom: .85rem;
      background: transparent;
    }

    /* Embed mode */
    body.embed-mode{
      background: transparent;
      margin: 0;
    }
    body.embed-mode #map{
      border-radius: 0;
      height: 80vh;
      box-shadow: none;
    }
    body.embed-mode .container{
      max-width: 100% !important;
      padding-left: 12px !important;
      padding-right: 12px !important;
    }

    /* Hide blocks via class (driven by query params) */
    .hide { display: none !important; }

    /* Accent buttons (no need to fight bootstrap themes) */
    .btn-accent{
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    .btn-accent:hover{
      filter: brightness(0.95);
      color:#fff;
    }
    .btn-outline-accent{
      border-color: color-mix(in srgb, var(--accent) 60%, #000 40%);
      color: color-mix(in srgb, var(--accent) 75%, #000 25%);
      background: transparent;
    }
    body.theme-dark .btn-outline-accent{
      border-color: color-mix(in srgb, var(--accent) 70%, #fff 30%);
      color: color-mix(in srgb, var(--accent) 85%, #fff 15%);
    }
    .btn-outline-accent:hover{
      background: color-mix(in srgb, var(--accent) 12%, transparent);
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav id="topNav" class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">Test Access</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#mapSection">Map</a></li>
          <li class="nav-item"><a class="nav-link" href="#embed" id="embedNavLink">Embed</a></li>
          <li class="nav-item"><a class="nav-link" href="https://github.com/ptoone/Test-Access" target="_blank" rel="noopener">GitHub</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section id="hero" class="hero py-5">
    <div class="container">
      <div class="row align-items-center g-4">
        <div class="col-lg-7">
          <h1 class="display-5 fw-bold mb-3">HIV Testing Map for Ontario</h1>
          <p class="lead mb-2">
            Search by postal code to find nearby clinics and organizations that can help with HIV testing.
          </p>
          <p class="small-muted mb-4">
            Privacy-first: your searches stay in your browser. Always confirm hours and service details before visiting.
          </p>

          <!-- Controls wrapper (can be hidden via ?search=0 or ?controls=0) -->
          <div id="controlsWrap" class="bg-white text-dark rounded-4 shadow-sm p-3 p-md-4">
            <div class="d-flex flex-column flex-md-row gap-2">
              <input id="postcodeInput" class="form-control searchbar"
                     placeholder="Enter an Ontario postal code (e.g. M5V 2T6) or town/city"
                     autocomplete="postal-code" inputmode="text">
              <button id="searchBtn" class="btn btn-accent pill-btn px-4" type="button">
                Search
              </button>
              <button id="showAllBtn" class="btn btn-outline-secondary pill-btn px-4" type="button">
                Show All
              </button>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Radius: <span id="radiusLabel">25</span> km</label>
                <input id="radiusRange" type="range" class="form-range" min="5" max="250" step="5" value="25">
                <div class="d-flex justify-content-between small text-muted">
                  <span>5 km</span><span>250 km</span>
                </div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label mb-1">Results</label>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="closestOnly">
                    <label class="form-check-label" for="closestOnly">Closest only</label>
                  </div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="useMyLocation">
                    <label class="form-check-label" for="useMyLocation">Use my location</label>
                  </div>
                  <span class="badge badge-soft">OpenStreetMap + Leaflet</span>
                </div>
                <div class="small text-muted mt-2">
                  Tip: “Use my location” stays in your browser (nothing is sent to us).
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-2">
              <button id="shareBtn" class="btn btn-dark pill-btn btn-sm" type="button">Copy share link</button>
              <button id="copyEmbedBtnTop" class="btn btn-outline-dark pill-btn btn-sm" type="button">Copy embed code</button>
              <span id="statusMsg" class="small text-muted"></span>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="bg-white text-dark rounded-4 shadow-sm p-4">
            <h2 class="h5 fw-bold mb-2">What this map shows</h2>
            <ul class="mb-0 ps-3">
              <li>Organizations and clinics across Ontario</li>
              <li>Search by postal code or location name</li>
              <li>Filter by distance radius</li>
              <li>Easy to share and embed</li>
            </ul>
            <hr>
            <div class="small text-muted">
              If you need urgent medical help, call 911 or your local emergency services.
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <main id="mainWrap" class="container py-4 pb-5">

    <section id="mapSection" class="mt-2">
      <div id="mapRow" class="row g-4">
        <div id="mapCol" class="col-lg-8">
          <div id="map" aria-label="Map of locations"></div>
          <div class="d-flex justify-content-between align-items-center mt-2 small text-muted">
            <div>
              Showing <span id="countInline">0</span> locations
            </div>
            <div>
              <code id="dataUrlDisplay" class="small"></code>
            </div>
          </div>
        </div>

        <div id="resultsCol" class="col-lg-4">
          <div class="card shadow-sm sticky-controls">
            <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
              <span>Nearby locations</span>
              <span class="badge text-bg-secondary" id="countBadge">0</span>
            </div>
            <div class="card-body">
              <div class="results-scroll">
                <div id="results" class="list-group list-group-flush"></div>
              </div>

              <div class="mt-3 small text-muted">
                Missing or incorrect info? Contribute on
                <a href="https://github.com/ptoone/Test-Access" target="_blank" rel="noopener">GitHub</a>.
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <section id="embed" class="mt-5">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Embed this map</div>
        <div class="card-body">
          <p class="mb-2">
            You can embed this map on any website using an <code>&lt;iframe&gt;</code>.
          </p>

          <div class="row g-3">
            <div class="col-lg-6">
              <label class="form-label">Map URL (embed-mode)</label>
              <input id="embedUrl" class="form-control" value="https://testaccess.xyz.am/?embed=1">
              <div class="form-text">Tip: the embed link includes the current zoom + centre.</div>
            </div>
            <div class="col-lg-6">
              <label class="form-label">Embed code</label>
              <textarea id="embedCode" class="form-control" rows="5" readonly></textarea>
              <div class="mt-2">
                <button id="copyEmbedBtn" class="btn btn-outline-secondary btn-sm" type="button">Copy</button>
              </div>
            </div>
          </div>

          <div class="small text-muted mt-3">
            You can change the iframe height/width in your own layout.
          </div>
        </div>
      </div>
    </section>

    <div id="footerLine" class="text-center text-muted small mt-4">
      Built with <a href="https://www.openstreetmap.org" target="_blank" rel="noopener">OpenStreetMap</a> and
      <a href="https://leafletjs.com" target="_blank" rel="noopener">Leaflet</a>.
      Please verify services before visiting.
    </div>

  </main>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /************************************************************
     * CONFIG
     ************************************************************/
    const DATA_URL = "https://raw.githubusercontent.com/ptoone/Test-Access/main/main/data/ontario.json";
    const DEFAULT_CENTER = [50.0, -85.0];
    const DEFAULT_ZOOM = 5;

    /************************************************************
     * QUERY PARAMS (embed options)
     ************************************************************/
    const qs = new URLSearchParams(location.search);

    const IS_EMBED = qs.get("embed") === "1";

    // theme: light | dark | auto (default auto)
    const THEME = (qs.get("theme") || "auto").toLowerCase();

    // tiles: osm | carto_light | carto_dark
    const TILES = (qs.get("tiles") || "osm").toLowerCase();

    // accent: hex like "00b46f" or "#00b46f"
    const ACCENT_RAW = (qs.get("accent") || "").trim();
    const ACCENT = ACCENT_RAW.replace("#","").match(/^[0-9a-fA-F]{6}$/) ? ("#" + ACCENT_RAW.replace("#","")) : null;

    // UI toggles (default to ON)
    const MAP_ONLY = qs.get("mapOnly") === "1";      // hides panels + makes map full width
    const SHOW_CONTROLS = qs.get("controls") !== "0"; // affects zoom control + top control block visibility
    const SHOW_RESULTS = qs.get("results") !== "0";
    const SHOW_SEARCH = qs.get("search") !== "0";

    /************************************************************
     * THEME + ACCENT APPLY
     ************************************************************/
    (function applyThemeAndAccent(){
      // Accent
      if (ACCENT) document.documentElement.style.setProperty("--accent", ACCENT);

      // Theme
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const useDark = (THEME === "dark") || (THEME === "auto" && prefersDark);
      document.body.classList.toggle("theme-dark", !!useDark);
    })();

    /************************************************************
     * EMBED/MAP-ONLY UI APPLY
     ************************************************************/
    (function applyEmbedUi(){
      if (IS_EMBED) {
        document.body.classList.add("embed-mode");
      }

      if (IS_EMBED || MAP_ONLY) {
        // Hide nav/hero/embed/footer line
        const nav = document.getElementById("topNav");
        const hero = document.getElementById("hero");
        const embedSec = document.getElementById("embed");
        const footerLine = document.getElementById("footerLine");
        const embedNavLink = document.getElementById("embedNavLink");
        if (nav) nav.classList.add("hide");
        if (hero) hero.classList.add("hide");
        if (embedSec) embedSec.classList.add("hide");
        if (footerLine) footerLine.classList.add("hide");
        if (embedNavLink) embedNavLink.classList.add("hide");

        // Make map full width
        const resultsCol = document.getElementById("resultsCol");
        const mapCol = document.getElementById("mapCol");
        if (mapCol) {
          mapCol.classList.remove("col-lg-8");
          mapCol.classList.add("col-12");
        }
        if (resultsCol) resultsCol.classList.add("hide");

        // tighten padding
        const main = document.getElementById("mainWrap");
        if (main) {
          main.classList.remove("py-4", "pb-5");
          main.style.padding = "12px";
          main.style.maxWidth = "100%";
        }
      } else {
        // not map-only: allow results toggle
        if (!SHOW_RESULTS) {
          const resultsCol = document.getElementById("resultsCol");
          const mapCol = document.getElementById("mapCol");
          if (resultsCol) resultsCol.classList.add("hide");
          if (mapCol) {
            mapCol.classList.remove("col-lg-8");
            mapCol.classList.add("col-12");
          }
        }
      }

      // Search UI toggle (control card in hero)
      if (!SHOW_SEARCH || !SHOW_CONTROLS) {
        const controlsWrap = document.getElementById("controlsWrap");
        if (controlsWrap) controlsWrap.classList.add("hide");
      }
    })();

    /************************************************************
     * HELPERS
     ************************************************************/
    function $(id){ return document.getElementById(id); }

    function setStatus(msg, isError=false){
      const el = $("statusMsg");
      if (!el) return;
      el.textContent = msg;
      el.className = "small " + (isError ? "text-danger" : "text-muted");
      if (msg) setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 5000);
    }

    function normalizeQuery(q){
      return (q || "").trim().replace(/\s+/g, " ");
    }

    function looksLikePostalCode(q){
      const s = q.toUpperCase().replace(/\s/g, "");
      return /^[A-Z]\d[A-Z]\d[A-Z]\d$/.test(s);
    }

    // Haversine (km)
    function distanceKm(aLat, aLng, bLat, bLng){
      const R = 6371;
      const toRad = d => d * Math.PI/180;
      const dLat = toRad(bLat - aLat);
      const dLng = toRad(bLng - aLng);
      const s1 = Math.sin(dLat/2);
      const s2 = Math.sin(dLng/2);
      const aa = s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
      return 2 * R * Math.asin(Math.sqrt(aa));
    }

    function escapeHtml(str){
      return String(str || "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function escapeAttr(str){
      return String(str || "").replace(/"/g, "&quot;");
    }

    /************************************************************
     * PERMALINKS
     ************************************************************/
    function getBase(){
      return location.origin + location.pathname;
    }

    // Full-page share link (no embed param)
    function getPermalink(){
      const c = map.getCenter();
      const z = map.getZoom();
      const base = getBase();
      return `${base}#${c.lat.toFixed(5)},${c.lng.toFixed(5)},${z}`;
    }

    // Embed link includes embed=1 + current options (theme/tiles/accent/ui) + hash view
    function getEmbedPermalink(){
      const c = map.getCenter();
      const z = map.getZoom();
      const base = getBase();
      const u = new URL(base, location.origin);

      u.searchParams.set("embed","1");

      // preserve options so embed builder links stay consistent
      if (THEME && THEME !== "auto") u.searchParams.set("theme", THEME);
      if (TILES && TILES !== "osm") u.searchParams.set("tiles", TILES);
      if (ACCENT) u.searchParams.set("accent", ACCENT.replace("#",""));

      // UI flags (only include when not defaults)
      u.searchParams.set("mapOnly", (IS_EMBED || MAP_ONLY) ? "1" : "0");
      u.searchParams.set("controls", SHOW_CONTROLS ? "1" : "0");
      u.searchParams.set("results", SHOW_RESULTS ? "1" : "0");
      u.searchParams.set("search", SHOW_SEARCH ? "1" : "0");

      u.hash = `${c.lat.toFixed(5)},${c.lng.toFixed(5)},${z}`;
      return u.toString();
    }

    function applyHashView(){
      if (!location.hash) return;
      const raw = location.hash.replace("#","").trim();
      const parts = raw.split(",");
      if (parts.length !== 3) return;
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      const zoom = parseInt(parts[2], 10);
      if (!isNaN(lat) && !isNaN(lng) && !isNaN(zoom)) {
        map.setView([lat,lng], zoom);
      }
    }

    function updateHashOnMove(){
      if (updateHashOnMove._t) clearTimeout(updateHashOnMove._t);
      updateHashOnMove._t = setTimeout(() => {
        const c = map.getCenter();
        const z = map.getZoom();
        history.replaceState(null, "", `${location.pathname}${location.search}#${c.lat.toFixed(5)},${c.lng.toFixed(5)},${z}`);
      }, 250);
    }

    /************************************************************
     * EMBED CODE BOX
     ************************************************************/
    function updateEmbedCode(){
      const url = ($("embedUrl") && $("embedUrl").value.trim()) ? $("embedUrl").value.trim() : getEmbedPermalink();
      if ($("embedCode")) {
        $("embedCode").value =
`<iframe
  src="${url}"
  width="100%"
  height="650"
  style="border:0;border-radius:12px;overflow:hidden"
  loading="lazy"
  referrerpolicy="no-referrer-when-downgrade">
</iframe>`;
      }
    }

    function copyToClipboard(text){
      return navigator.clipboard.writeText(text);
    }

    /************************************************************
     * TILE STYLES
     ************************************************************/
    const TILE_STYLES = {
      osm: {
        url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        options: {
          maxZoom: 19,
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a>'
        }
      },
      carto_light: {
        url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        options: {
          maxZoom: 20,
          subdomains: "abcd",
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>'
        }
      },
      carto_dark: {
        url: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        options: {
          maxZoom: 20,
          subdomains: "abcd",
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>'
        }
      }
    };

    function pickTileStyle(){
      // If tiles=carto_dark but theme is light, still allow it — it’s a deliberate choice.
      return TILE_STYLES[TILES] || TILE_STYLES.osm;
    }

    /************************************************************
     * LEAFLET MAP
     ************************************************************/
    const map = L.map("map", { zoomControl: SHOW_CONTROLS });

    const tileDef = pickTileStyle();
    L.tileLayer(tileDef.url, tileDef.options).addTo(map);

    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    applyHashView();
    map.on("moveend", updateHashOnMove);

    const markersLayer = L.layerGroup().addTo(map);

    let originMarker = null;
    let radiusCircle = null;

    function clearOrigin(){
      if (originMarker) { map.removeLayer(originMarker); originMarker = null; }
      if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
    }

    function setOrigin(lat, lng, label){
      clearOrigin();
      originMarker = L.marker([lat,lng]).addTo(map).bindPopup(label || "Search area");
      radiusCircle = L.circle([lat,lng], { radius: parseInt($("radiusRange")?.value || "25", 10) * 1000 }).addTo(map);
    }

    function setRadiusCircleKm(km){
      if (!radiusCircle) return;
      radiusCircle.setRadius(km * 1000);
    }

    /************************************************************
     * DATA
     ************************************************************/
    if ($("dataUrlDisplay")) $("dataUrlDisplay").textContent = DATA_URL;

    let locations = [];

    async function fetchLocations(){
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load data.");
      return await res.json();
    }

    function popupHtml(loc, distText){
      const org = escapeHtml(loc.organization || "Unknown");
      const addr = escapeHtml(loc.address || "");
      const city = escapeHtml(loc.city || "");
      const area = escapeHtml(loc.service_area || "");
      const website = loc.website ? `<a href="${escapeAttr(loc.website)}" target="_blank" rel="noopener">Visit website</a>` : "";
      const dist = distText ? `<div class="small text-muted mt-1">${distText}</div>` : "";

      return `
        <div style="min-width:220px">
          <div class="fw-semibold">${org}</div>
          <div class="small">${addr}${addr && city ? ", " : ""}${city}</div>
          ${area ? `<div class="small text-muted mt-1">${area}</div>` : ""}
          ${website ? `<div class="mt-2">${website}</div>` : ""}
          ${dist}
        </div>
      `;
    }

    function renderMarkers(list, origin){
      markersLayer.clearLayers();

      const bounds = [];
      list.forEach(loc => {
        if (typeof loc.latitude !== "number" || typeof loc.longitude !== "number") return;

        const distText = origin ? `${loc._distanceKm.toFixed(1)} km away` : "";
        const m = L.marker([loc.latitude, loc.longitude]).bindPopup(popupHtml(loc, distText));
        m.addTo(markersLayer);

        loc._marker = m;
        bounds.push([loc.latitude, loc.longitude]);
      });

      if (origin) bounds.push([origin.lat, origin.lng]);

      if (bounds.length){
        map.fitBounds(L.latLngBounds(bounds).pad(0.2));
      }
    }

    function renderResults(list){
      const el = $("results");
      if (!el) return;
      el.innerHTML = "";

      if ($("countBadge")) $("countBadge").textContent = String(list.length);
      if ($("countInline")) $("countInline").textContent = String(list.length);

      if (!list.length){
        el.innerHTML = `<div class="text-muted small p-2">No results yet. Search by postal code or click “Show All”.</div>`;
        return;
      }

      list.forEach(loc => {
        const a = document.createElement("a");
        a.href = "#";
        a.className = "list-group-item list-group-item-action result-item";

        const dist = (typeof loc._distanceKm === "number")
          ? `<div class="small text-muted">${loc._distanceKm.toFixed(1)} km away</div>`
          : "";

        a.innerHTML = `
          <div class="fw-semibold">${escapeHtml(loc.organization || "Unknown")}</div>
          <div class="small">${escapeHtml(loc.address || "")}${loc.address && loc.city ? ", " : ""}${escapeHtml(loc.city || "")}</div>
          ${dist}
        `;

        a.addEventListener("click", (e) => {
          e.preventDefault();
          if (loc._marker){
            map.setView(loc._marker.getLatLng(), Math.max(map.getZoom(), 12));
            loc._marker.openPopup();
          }
        });

        el.appendChild(a);
      });
    }

    /************************************************************
     * GEOCODE USER SEARCH (Nominatim)
     ************************************************************/
    async function nominatimSearch(q){
      const url = new URL("https://nominatim.openstreetmap.org/search");
      url.searchParams.set("format", "json");
      url.searchParams.set("limit", "1");
      url.searchParams.set("addressdetails", "1");
      url.searchParams.set("q", q);

      const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Geocoder error");
      const j = await res.json();
      return j && j[0] ? { lat: parseFloat(j[0].lat), lng: parseFloat(j[0].lon) } : null;
    }

    async function geocodeToLatLng(query){
      const q = normalizeQuery(query);
      if (!q) return null;

      const enriched = looksLikePostalCode(q)
        ? `${q}, Ontario, Canada`
        : `${q}, Ontario, Canada`;

      return await nominatimSearch(enriched);
    }

    /************************************************************
     * SEARCH / FILTER
     ************************************************************/
    async function showAll(){
      setStatus("Showing all locations…");
      clearOrigin();

      const list = locations
        .filter(l => typeof l.latitude === "number" && typeof l.longitude === "number")
        .map(l => ({ ...l, _distanceKm: undefined }));

      renderMarkers(list, null);

      if (SHOW_RESULTS && $("resultsCol") && !$("resultsCol").classList.contains("hide")) {
        renderResults(list);
      } else {
        // still update counts
        if ($("countBadge")) $("countBadge").textContent = String(list.length);
        if ($("countInline")) $("countInline").textContent = String(list.length);
      }

      setStatus(`Showing ${list.length} locations.`);

      if ($("embedUrl")) $("embedUrl").value = getEmbedPermalink();
      updateEmbedCode();
    }

    async function runSearchByOrigin(origin){
      const radiusKm = parseInt($("radiusRange")?.value || "25", 10);
      setOrigin(origin.lat, origin.lng, "Search area");
      setRadiusCircleKm(radiusKm);

      const list = [];
      for (const loc of locations){
        if (typeof loc.latitude !== "number" || typeof loc.longitude !== "number") continue;

        const d = distanceKm(origin.lat, origin.lng, loc.latitude, loc.longitude);
        const copy = { ...loc, _distanceKm: d };

        if (d <= radiusKm) list.push(copy);
      }

      list.sort((a,b) => a._distanceKm - b._distanceKm);

      const closestOnly = $("closestOnly")?.checked;

      if (closestOnly && list.length){
        renderMarkers([list[0]], origin);
        if (SHOW_RESULTS && $("resultsCol") && !$("resultsCol").classList.contains("hide")) renderResults([list[0]]);
        setStatus("Showing closest location.");
      } else {
        renderMarkers(list, origin);
        if (SHOW_RESULTS && $("resultsCol") && !$("resultsCol").classList.contains("hide")) renderResults(list);
        setStatus(`Found ${list.length} within ${radiusKm} km.`);
      }

      if ($("embedUrl")) $("embedUrl").value = getEmbedPermalink();
      updateEmbedCode();
    }

    async function search(){
      const q = normalizeQuery($("postcodeInput")?.value || "");

      const useMyLocation = $("useMyLocation")?.checked;

      if (!q && !useMyLocation){
        setStatus("Enter a postal code or enable “Use my location”.", true);
        return;
      }

      if (useMyLocation){
        setStatus("Getting your location…");
        navigator.geolocation.getCurrentPosition(async (pos) => {
          await runSearchByOrigin({ lat: pos.coords.latitude, lng: pos.coords.longitude });
        }, () => {
          setStatus("Could not access location. Please enter a postal code instead.", true);
        }, { enableHighAccuracy: false, timeout: 8000 });
        return;
      }

      setStatus("Searching…");
      try{
        const origin = await geocodeToLatLng(q);
        if (!origin){
          setStatus("Couldn’t find that location. Try a different postal code or city.", true);
          return;
        }
        await runSearchByOrigin(origin);
      } catch (e){
        setStatus("Search failed. Try again in a moment.", true);
      }
    }

    /************************************************************
     * UI EVENTS (only wire up if those elements exist)
     ************************************************************/
    $("radiusRange")?.addEventListener("input", () => {
      if ($("radiusLabel")) $("radiusLabel").textContent = $("radiusRange").value;
      setRadiusCircleKm(parseInt($("radiusRange").value, 10));
      if (originMarker){
        const ll = originMarker.getLatLng();
        runSearchByOrigin({ lat: ll.lat, lng: ll.lng });
      }
    });

    $("searchBtn")?.addEventListener("click", search);
    $("showAllBtn")?.addEventListener("click", showAll);
    $("postcodeInput")?.addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });

    $("closestOnly")?.addEventListener("change", () => {
      if (originMarker){
        const ll = originMarker.getLatLng();
        runSearchByOrigin({ lat: ll.lat, lng: ll.lng });
      }
    });

    $("useMyLocation")?.addEventListener("change", () => {
      if ($("useMyLocation").checked){
        setStatus("Tip: click Search to use your current location.");
      }
    });

    // Share = full page link (no embed param)
    $("shareBtn")?.addEventListener("click", async () => {
      try{
        const link = getPermalink();
        await copyToClipboard(link);
        setStatus("Share link copied.");
      } catch {
        setStatus("Couldn’t copy. Select the URL from the address bar.", true);
      }
    });

    // Embed = embed-mode link (?embed=1 + options + hash)
    function copyEmbedCurrent(){
      const link = getEmbedPermalink();
      if ($("embedUrl")) $("embedUrl").value = link;
      updateEmbedCode();

      copyToClipboard($("embedCode").value)
        .then(() => setStatus("Embed code copied."))
        .catch(() => setStatus("Couldn’t copy embed code.", true));
    }

    $("copyEmbedBtnTop")?.addEventListener("click", copyEmbedCurrent);
    $("copyEmbedBtn")?.addEventListener("click", () => {
      copyToClipboard($("embedCode").value)
        .then(() => setStatus("Embed code copied."))
        .catch(() => setStatus("Couldn’t copy embed code.", true));
    });

    $("embedUrl")?.addEventListener("input", updateEmbedCode);

    /************************************************************
     * INIT
     ************************************************************/
    (async function init(){
      updateEmbedCode();

      try{
        setStatus("Loading data…");
        const data = await fetchLocations();

        locations = (Array.isArray(data) ? data : []).map(x => ({
          id: x.id,
          organization: x.organization,
          address: x.address,
          city: x.city,
          service_area: x.service_area,
          website: x.website,
          latitude: (typeof x.latitude === "number") ? x.latitude : parseFloat(x.latitude),
          longitude: (typeof x.longitude === "number") ? x.longitude : parseFloat(x.longitude)
        }));

        await showAll();

        // If hash exists, it overrides view
        applyHashView();

        // keep embed URL in sync
        if ($("embedUrl")) $("embedUrl").value = getEmbedPermalink();
        updateEmbedCode();

        setStatus(IS_EMBED || MAP_ONLY ? "" : "Ready. Search by postal code to filter nearby.");
      } catch (e){
        console.error(e);
        setStatus("Could not load the locations file. Check DATA_URL and JSON validity.", true);
      }
    })();
  </script>
</body>
</html>
